# üîÑ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ AiR_Common v1.26.0

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –≤–∞—à –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.

---

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### Breaking Changes:

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `Ch`** —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—Ç–æ–º–∞—Ä–Ω—ã–µ —Ñ–ª–∞–≥–∏
2. **–•—Ä–∞–Ω–µ–Ω–∏–µ `Ch`** - —Ç–æ–ª—å–∫–æ –ø–æ —É–∫–∞–∑–∞—Ç–µ–ª—é (`*Ch`)
3. **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `GetCh`** - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `*Ch` –≤–º–µ—Å—Ç–æ `Ch`

---

## üîß –ü–æ—à–∞–≥–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ go.mod

```bash
go get github.com/ikermy/AiR_Common@v1.26.0
go mod tidy
```

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–º–ø–∏–ª—è—Ü–∏—é –∏ –Ω–∞–π–¥–∏—Ç–µ –æ—à–∏–±–∫–∏:

```bash
go build ./...
```

#### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:

**–û—à–∏–±–∫–∞ 1**: `cannot use Ch{...} (type model.Ch) as type *model.Ch`

```go
// –ë–´–õ–û:
ch := model.Ch{
    TxCh: make(chan model.Message, 1),
    RxCh: make(chan model.Message, 1),
}

// –°–¢–ê–õ–û:
ch := &model.Ch{
    TxCh: make(chan model.Message, 1),
    RxCh: make(chan model.Message, 1),
}
```

**–û—à–∏–±–∫–∞ 2**: `cannot use model.Ch as type *model.Ch in map value`

```go
// –ë–´–õ–û:
type MyStruct struct {
    channels map[uint64]model.Ch
}

// –°–¢–ê–õ–û:
type MyStruct struct {
    channels map[uint64]*model.Ch
}
```

**–û—à–∏–±–∫–∞ 3**: `cannot use ch (type model.Ch) as type *model.Ch in argument`

```go
// –ë–´–õ–û:
func ProcessChannel(ch model.Ch) {...}

// –°–¢–ê–õ–û:
func ProcessChannel(ch *model.Ch) {...}
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ GetCh

```go
// –ë–´–õ–û:
ch, err := model.GetCh(respId)
if err != nil {
    return err
}

// –°–¢–ê–õ–û (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —Ç–µ–ø–µ—Ä—å ch - —ç—Ç–æ *model.Ch):
ch, err := model.GetCh(respId)
if err != nil {
    return err
}
```

### –®–∞–≥ 4: –ó–∞–º–µ–Ω–∞ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ù–∞–π–¥–∏—Ç–µ –≤—Å–µ –º–µ—Å—Ç–∞ —Å –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –∫–∞–Ω–∞–ª—ã:

```bash
# –ü–æ–∏—Å–∫ –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
grep -r "\.RxCh <-" .
grep -r "\.TxCh <-" .
```

–ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

```go
// –ë–´–õ–û (–û–ü–ê–°–ù–û):
usrCh.RxCh <- userMessage

// –°–¢–ê–õ–û (–ë–ï–ó–û–ü–ê–°–ù–û):
if err := usrCh.SendToRx(userMessage); err != nil {
    logger.Error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %d: %v", userId, err)
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏:
    // 1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∏—Ç—å
    // 2. –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // 3. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
    return err
}
```

```go
// –ë–´–õ–û (–û–ü–ê–°–ù–û):
usrCh.TxCh <- assistMessage

// –°–¢–ê–õ–û (–ë–ï–ó–û–ü–ê–°–ù–û):
if err := usrCh.SendToTx(assistMessage); err != nil {
    logger.Error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: %v", err)
    return err
}
```

### –®–∞–≥ 5: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏:

```go
if !usrCh.IsRxOpen() {
    logger.Warn("–ö–∞–Ω–∞–ª RxCh –∑–∞–∫—Ä—ã—Ç –¥–ª—è dialogId %d", dialogId)
    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª –∏–ª–∏ —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return fmt.Errorf("–∫–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç")
}

msg := model.Message{...}
if err := usrCh.SendToRx(msg); err != nil {
    return err
}
```

---

## üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞:

```bash
# –ù–∞–π—Ç–∏ –ø—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ Ch (–±–µ–∑ —É–∫–∞–∑–∞—Ç–µ–ª—è)
grep -rn "Ch{" . --include="*.go" | grep -v "*Ch{"

# –ù–∞–π—Ç–∏ map —Å Ch –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é
grep -rn "map\[.*\].*Ch" . --include="*.go" | grep -v "\*Ch"

# –ù–∞–π—Ç–∏ –ø—Ä—è–º—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª—ã
grep -rn "\.RxCh <-\|\.TxCh <-" . --include="*.go"
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

### 1. –ö–æ–º–ø–∏–ª—è—Ü–∏—è:
```bash
go build ./...
```

### 2. –¢–µ—Å—Ç—ã:
```bash
go test ./...
```

### 3. –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫:
```bash
go run ./cmd/...
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π:
- `"–ü–∞–Ω–∏–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ RxCh"`
- `"–ü–∞–Ω–∏–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ TxCh"`
- `"–∫–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç –∏–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω"`

---

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ü–∞—Ç—Ç–µ—Ä–Ω 1: Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

```go
func sendWithRetry(ch *model.Ch, msg model.Message, maxRetries int) error {
    for i := 0; i < maxRetries; i++ {
        if err := ch.SendToRx(msg); err == nil {
            return nil
        }
        
        // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        time.Sleep(time.Duration(1<<uint(i)) * 100 * time.Millisecond)
    }
    return fmt.Errorf("–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ %d –ø–æ–ø—ã—Ç–æ–∫", maxRetries)
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω 2: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞

```go
func ensureChannelOpen(respModel *model.RespModel, respId uint64) (*model.Ch, error) {
    respModel.mu.Lock()
    defer respModel.mu.Unlock()
    
    ch, exists := respModel.Chan[respId]
    if !exists || !ch.IsRxOpen() {
        // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª
        ch = &model.Ch{
            TxCh:     make(chan model.Message, 1),
            RxCh:     make(chan model.Message, 1),
            UserId:   respModel.Assist.UserId,
            DialogId: respId,
            RespName: respModel.RespName,
        }
        respModel.Chan[respId] = ch
    }
    return ch, nil
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω 3: Graceful fallback

```go
if err := ch.SendToRx(msg); err != nil {
    logger.Warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –∫–∞–Ω–∞–ª: %v", err)
    
    // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏
    if err := db.SavePendingMessage(userId, msg); err != nil {
        logger.Error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: %v", err)
    }
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return fmt.Errorf("—Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ")
}
```

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–ï—Å–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –∫–æ–¥:

### –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å defer recover:

```go
func safeSend(ch chan model.Message, msg model.Message) (err error) {
    defer func() {
        if r := recover(); r != nil {
            err = fmt.Errorf("–ø–∞–Ω–∏–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: %v", r)
            logger.Error("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ—Å–ª–µ –ø–∞–Ω–∏–∫–∏: %v", r)
        }
    }()
    
    select {
    case ch <- msg:
        return nil
    default:
        return fmt.Errorf("–∫–∞–Ω–∞–ª –∑–∞–∫—Ä—ã—Ç –∏–ª–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω")
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
if err := safeSend(usrCh.RxCh, msg); err != nil {
    logger.Error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
}
```

---

## üìä –ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –û–±–Ω–æ–≤–ª–µ–Ω `go.mod` –¥–æ v1.26.0
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Å `Ch`
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã map —Å `Ch` –Ω–∞ `*Ch`
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω—ã —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Ñ—É–Ω–∫—Ü–∏–π —Å `Ch` –Ω–∞ `*Ch`
- [ ] –ó–∞–º–µ–Ω–µ–Ω–∞ –ø—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ `SendToRx`/`SendToTx`
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
- [ ] –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–∞–Ω–∏–∫
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏

---

## üÜò –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ lock"

**–û—à–∏–±–∫–∞:**
```
assignment copies lock value to ch: model.Ch contains atomic.Bool
```

**–†–µ—à–µ–Ω–∏–µ:**
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏:
```go
// –ù–ï –¢–ê–ö:
ch := respModel.Chan[respId]

// –¢–ê–ö:
ch := respModel.Chan[respId] // —É–∂–µ —É–∫–∞–∑–∞—Ç–µ–ª—å –∏–∑ map
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "–∫–∞–Ω–∞–ª –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω"

**–û—à–∏–±–∫–∞:**
```
–∫–∞–Ω–∞–ª TxCh –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω –¥–ª—è dialogId 123
```

**–†–µ—à–µ–Ω–∏–µ:**
–£–≤–µ–ª–∏—á—å—Ç–µ –±—É—Ñ–µ—Ä –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É:
```go
ch := &model.Ch{
    TxCh: make(chan model.Message, 10), // —É–≤–µ–ª–∏—á–µ–Ω –±—É—Ñ–µ—Ä
    RxCh: make(chan model.Message, 10),
}
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: "nil pointer dereference"

**–û—à–∏–±–∫–∞:**
```
panic: runtime error: invalid memory address or nil pointer dereference
```

**–†–µ—à–µ–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–∞–Ω–∞–ª –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
```go
if ch == nil {
    return fmt.Errorf("–∫–∞–Ω–∞–ª –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
}

if err := ch.SendToRx(msg); err != nil {
    return err
}
```

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [CHANGELOG.md](CHANGELOG.md)
2. –ò–∑—É—á–∏—Ç–µ [IMPLEMENTATION_REPORT.md](IMPLEMENTATION_REPORT.md)
3. –°–æ–∑–¥–∞–π—Ç–µ issue —Å:
   - –í–µ—Ä—Å–∏–µ–π Go
   - –§—Ä–∞–≥–º–µ–Ω—Ç–æ–º –∫–æ–¥–∞ —Å –æ—à–∏–±–∫–æ–π
   - –ü–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –æ—à–∏–±–∫–∏
   - –®–∞–≥–∞–º–∏ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

---

**–í–µ—Ä—Å–∏—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞**: 1.0  
**–î–∞—Ç–∞**: 2025-11-30  
**–ê–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è**: AiR_Common v1.26.0

